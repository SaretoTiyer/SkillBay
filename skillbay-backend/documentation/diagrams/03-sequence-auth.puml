' SkillBay - Diagrama de Secuencia: Registro y Autenticación
' Flujo de usuario Regístrate e inicia sesión
' Generado para análisis del sistema

actor Usuario
participant "Frontend\n(React)" as Frontend
participant "API Routes" as Routes
participant "UsuarioController" as Controller
participant "Usuario\n(Model)" as Model
participant "Plan\n(Model)" as Plan
participant "Token\n(Sanctum)" as Token
database "Database" as DB

title Flujo de Registro y Autenticación de Usuario

' ============================================
' CASO DE USO: REGISTRO
' ============================================

activate Usuario
Usuario -> Frontend : Accede a página de registro
activate Frontend
Frontend --> Usuario : Muestra formulario de registro
deactivate Frontend

Usuario -> Frontend : Ingresa datos del formulario\n(nombre, email, password, etc.)
activate Frontend
Frontend -> Routes : POST /api/register\n{datos}
activate Routes
Routes -> Controller : register(Request)
activate Controller

Controller -> Model : valida datos()
activate Model
Model --> Controller : datos válidos
deactivate Model

Controller -> Model : crea nuevo Usuario()
activate Model
Model -> DB : INSERT INTO usuarios
activate DB
DB --> Model : usuario creado
deactivate DB

Controller -> Token : genera token de acceso()
activate Token
Token --> Controller : access_token
deactivate Token

Controller --> Routes : {usuario, token}
deactivate Controller
Routes --> Frontend : {usuario, token}
deactivate Routes
Frontend --> Usuario : Registro exitoso\nRedirigir a dashboard
deactivate Frontend

' ============================================
' CASO DE USO: LOGIN
' ============================================

Usuario -> Frontend : Accede a página de login
activate Frontend
Frontend --> Usuario : Muestra formulario de login
deactivate Frontend

Usuario -> Frontend : Ingresa email y password
activate Frontend
Frontend -> Routes : POST /api/login\n{email, password}
activate Routes
Routes -> Controller : login(Request)
activate Controller

Controller -> Model : busca por email()
activate Model
Model -> DB : SELECT * FROM usuarios\nWHERE email = ?
activate DB

alt Usuario encontrado
    DB --> Model : usuario
    deactivate DB
    Model --> Controller : usuario encontrado
    deactivate Model
    
    Controller -> Model : verifica password()
    activate Model
    Model --> Controller : password válida
    deactivate Model
    
    Controller -> Token : crea token()
    activate Token
    Token --> Controller : access_token
    deactivate Token
    
    Controller --> Routes : {usuario, token}
    deactivate Controller
    Routes --> Frontend : {usuario, token}
    deactivate Routes
    Frontend --> Usuario : Login exitoso\nRedirigir a dashboard
    deactivate Frontend
    
else Usuario no encontrado o password incorrecta
    DB --> Model : null
    deactivate DB
    Model --> Controller : null
    deactivate Model
    
    Controller --> Routes : {error: credenciales inválidas}
    deactivate Controller
    Routes --> Frontend : {error}
    deactivate Routes
    Frontend --> Usuario : Error: Credenciales incorrectas
    deactivate Frontend
end

' ============================================
' CASO DE USO: RECUPERACIÓN DE CONTRASEÑA
' ============================================

Usuario -> Frontend : Solicita recuperación de contraseña
activate Frontend
Frontend -> Routes : POST /api/recovery\n{email}
activate Routes
Routes -> Controller : solicitarRecuperacion(Request)
activate Controller

Controller -> Model : busca usuario por email()
activate Model
Model -> DB : SELECT * FROM usuarios\nWHERE email = ?
activate DB
DB --> Model : usuario
deactivate DB
Model --> Controller : usuario
deactivate Model

Controller -> Controller : genera código de recuperación()
Controller -> Model : guarda código()
activate Model
Model -> DB : UPDATE usuarios\nSET recovery_code = ?
activate DB
DB --> Model : actualizado
deactivate DB
Model --> Controller : código guardado
deactivate Model

Controller --> Routes : {mensaje: código enviado}
deactivate Controller
Routes --> Frontend : {mensaje}
deactivate Routes
Frontend --> Usuario : Código enviado a tu email
deactivate Frontend

Usuario -> Frontend : Ingresa código y nueva contraseña
activate Frontend
Frontend -> Routes : POST /api/reset-password\n{code, password}
activate Routes
Routes -> Controller : restablecerContraseña(Request)
activate Controller

Controller -> Model : busca y verifica código()
activate Model
Model -> DB : SELECT * FROM usuarios\nWHERE recovery_code = ?
activate DB
DB --> Model : usuario
deactivate DB
Model --> Controller : código válido
deactivate Model

Controller -> Model : actualiza password()
activate Model
Model -> DB : UPDATE usuarios\nSET password = ?, recovery_code = null
activate DB
DB --> Model : actualizado
deactivate DB
Model --> Controller : password actualizada
deactivate Model

Controller --> Routes : {mensaje: contraseña actualizada}
deactivate Controller
Routes --> Frontend : {mensaje}
deactivate Routes
Frontend --> Usuario : Contraseña actualizada\nInicia sesión
deactivate Frontend

deactivate Usuario

' ============================================
' NOTAS
' ============================================

note right of Token
    Laravel Sanctum genera
    tokens de acceso stateless
    para autenticación API
end note
